# ICE updater components analysis

## 1. Scripts touching ICE updater stages

### /usr/bin/audio_watchdog_helpers
- Before forcing reboots, the helper checks the ICE/SX updater sentinel at `/var/spool/ice-updater/gostaged/gostaged_in_progress` (and the SX equivalent) and treats `GUI_softwareUpdateInProgress`/in-progress sentinels as indicators that a staged update is running. When it sees a kernel error at sleep it only defers reboot if those sentinels are present, otherwise it logs and reboots immediately. This ties the audio watchdog into the *gostaged* stage, guarding against interrupting pre-install maintenance while ICE invokes `gostaged` (the same sentinel the updater creates when staging updates). ([source: `/root/downloads/mcu2-extracted/usr/bin/audio_watchdog_helpers`])

### /usr/bin/factory-reset.sh
- The factory-reset flow reruns `update-cleanup-tasks` for `gw_feature_zero` and `SWR/DRIVE`, removes `/var/spool/ice-updater` (and the SX spool) unless a `gostaged_in_progress` sentinel already exists, and only then reinterprets it as part of `clean_up*`/`reenable_telemetry_upload` housekeeping. This indicates the factory reset is aware of ICE/SX updater state and clears the *gostaged* (pre-install) data only when staging is idle, preventing partial install retries. ([source: `/root/downloads/mcu2-extracted/usr/bin/factory-reset.sh`])

### /deploy/ice-fpt-update
- The deploy script unlocks SPI programming via `FPT`, refuses to run if the board is fused, and builds an IFWI image either from a ready `ice-elk-spi.bin` or by assembling `iasUpdate`/`spi/{sfd,pdr,cse}` pieces before invoking `FPT` with `/etc/fparts.txt`. It logs attempts, enforces a 300-second timeout per try, and retires on five failures. Its tight coupling to SPI update tooling is the *recovery kernel* branch of the installer that runs *during gostaged* when a recovery SPI image must be flashed (the strings in the ICE updater binary report `gostaged component=recovery_kernel status=ifwi_update` and related success/failure paths). ([source: `/root/downloads/mcu2-extracted/deploy/ice-fpt-update` and strings from `/root/downloads/model3y-extracted/deploy/ice-updater`])

### /usr/sbin/deploy-emmc-update.sh + `/deploy/micron/emmc_update.*`
- The EMMC deploy script simply remounts `/mnt/mmcblk0p1` read-write, wipes the existing `/mnt/mmcblk0p1/micron/` tree, copies `/deploy/micron` (which contains `emmc_update.bin`, `.pnm`, `.sig`, and `.version` metadata) into that partition, syncs, and remounts read-only. This replicates the `gostaged component=emmc status=deploying_emmc_update` path that the ICE updater binary logs when it stages flash packages. ([source: `/root/downloads/mcu2-extracted/usr/sbin/deploy-emmc-update.sh` and `/root/downloads/mcu2-extracted/deploy/micron/emmc_update.version`; also strings from `/root/downloads/model3y-extracted/deploy/ice-updater` referencing the same stage]).

## 2. ICE updater daemon/service
- The ICE updater runs as a `runit` service (`/etc/sv/ice-updater`) whose `run` script removes old `/var/spool/*-updater-backup-*` archives, ensures `/dev/mmcblk0p1` is owned by `updater`, and execs `/bin/ice-updater`. The service is enabled via `/service/ice-updater` pointing to that `sv` tree, so the ELF binary is the main orchestrator. ([source: `/root/downloads/model3y-extracted/etc/sv/ice-updater/run` and `/root/downloads/model3y-extracted/service/ice-updater`])
- The ICE updater’s log run script wraps `svlogd` so logs appear under `/var/log/ice-updater/current`, and Hermes eventlog configs route that log path for historical/uploaded analytics, confirming the daemon emits the statuses we observe. ([source: `/root/downloads/model3y-extracted/etc/sv/ice-updater/log/run` and `etc/hermes-eventlogs/monitor/var.log.ice-updater.current`])

## 3. Update stage and spool mapping
- The binary’s built-in strings describe the `gostaged` state machine (received commands, `force_gostaged`, `stealth_gostaged`, `gostaged_in_progress`, staging completion, etc.), the per-component logging for `gateway`, `emmc`, and `recovery_kernel`, the handshake/output flow, and the transition to `complete_update`. This is evidence that ICE updater handles the classic *gostaged pre-install* stage (including gating `gateway` updates and initiating `gostaged component=emmc/recovery_kernel` work) before moving into install/reboot reporting. ([source: `strings /root/downloads/model3y-extracted/deploy/ice-updater | grep -i gostaged`])
- The spool layout is referenced multiple times: `/var/spool` is the root, and the daemon explicitly removes old `*-updater-backup-*` archives before starting. Strings mention `respool`/`initialize_spool`, sub-spool resume, and `ice_backup_spool`, reflecting spool recovery logic; there are dedicated subdirectories such as `/var/spool/cid-updater/vrmbackup` plus operations to save pending commands and `gostaged` sentinels (e.g., `gostaged_in_progress`, `pending-command-uiwarn`). ([source: `strings /root/downloads/model3y-extracted/deploy/ice-updater | grep -i spool`])
- The audio watchdog looking for `/var/spool/ice-updater/gostaged/gostaged_in_progress` reinforces that the primary per-update spool holds a `gostaged` subtree with sentinel files for in-progress staging. Factory reset clears `/var/spool/ice-updater` only when these sentinels are absent, confirming that the spool contains both command state and completions for the `gostaged` stage. ([source: `/root/downloads/mcu2-extracted/usr/bin/audio_watchdog_helpers` and `/root/downloads/mcu2-extracted/usr/bin/factory-reset.sh`])

## 4. Deliverables
- ICE-specific daemon: `/bin/ice-updater`, managed via `/etc/sv/ice-updater`, drives `gostaged`/install logging and spool cleanup.
- Script coverage: audio watchdog guards `gostaged` start/stop; factory reset wipes spool metadata; `deploy-emmc-update.sh` handles the `emmc` install payload; `ice-fpt-update` handles SPI/`recovery_kernel` installs that require FPT.
- Spool layout: root `/var/spool`, per-updater directories (`ice-updater`, `cid-updater`, backups like `*-updater-backup-*`), `gostaged` subdirectories containing sentinel files, and the risk paths the daemon monitors/resumes when the device boots.
