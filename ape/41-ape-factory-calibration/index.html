<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Comprehensive security analysis of Tesla Model S/X/3/Y MCU2 and Gateway"><meta name=author content="Security Researcher"><link href=https://talas9.github.io/tesla-research/ape/41-ape-factory-calibration/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Tesla APE Factory Mode & Calibration System Analysis - Tesla MCU2 Security Research</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent=red> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#tesla-ape-factory-mode-calibration-system-analysis class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Tesla MCU2 Security Research" class="md-header__button md-logo" aria-label="Tesla MCU2 Security Research" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Tesla MCU2 Security Research </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Tesla APE Factory Mode &amp; Calibration System Analysis </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent=red aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=red data-md-color-accent=red aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/talas9/tesla-research title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> talas9/tesla-research </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../INDEX/ class=md-tabs__link> Complete Index </a> </li> <li class=md-tabs__item> <a href=../../DEPLOYMENT/ class=md-tabs__link> Deployment Guide </a> </li> <li class=md-tabs__item> <a href=../../core/00-master-cross-reference/ class=md-tabs__link> Core Research </a> </li> <li class=md-tabs__item> <a href=../../gateway/81-gateway-secure-configs-CRITICAL/ class=md-tabs__link> Gateway Security </a> </li> <li class=md-tabs__item> <a href=../../mcu/24-mcu-architecture.md class=md-tabs__link> MCU Research </a> </li> <li class=md-tabs__item> <a href=../../evidence/59-EVIDENCE-AUDIT/ class=md-tabs__link> Evidence & Audit </a> </li> <li class=md-tabs__item> <a href=../../tools/56-tools-gateway-database-query.md class=md-tabs__link> Tools & Scripts </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Tesla MCU2 Security Research" class="md-nav__button md-logo" aria-label="Tesla MCU2 Security Research" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Tesla MCU2 Security Research </label> <div class=md-nav__source> <a href=https://github.com/talas9/tesla-research title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> talas9/tesla-research </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../INDEX/ class=md-nav__link> <span class=md-ellipsis> Complete Index </span> </a> </li> <li class=md-nav__item> <a href=../../DEPLOYMENT/ class=md-nav__link> <span class=md-ellipsis> Deployment Guide </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Core Research </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Core Research </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../core/00-master-cross-reference/ class=md-nav__link> <span class=md-ellipsis> Master Cross-Reference </span> </a> </li> <li class=md-nav__item> <a href=../../core/02-gateway-can-flood-exploit/ class=md-nav__link> <span class=md-ellipsis> Gateway CAN Flood Exploit </span> </a> </li> <li class=md-nav__item> <a href=../../core/03-certificate-recovery-orphan-cars/ class=md-nav__link> <span class=md-ellipsis> Certificate Recovery </span> </a> </li> <li class=md-nav__item> <a href=../../core/04-network-ports-firewall/ class=md-nav__link> <span class=md-ellipsis> Network Topology </span> </a> </li> <li class=md-nav__item> <a href=../../core/06-usb-firmware-update/ class=md-nav__link> <span class=md-ellipsis> USB Firmware Update </span> </a> </li> <li class=md-nav__item> <a href=../../core/07-usb-map-installation/ class=md-nav__link> <span class=md-ellipsis> USB Map Installation </span> </a> </li> <li class=md-nav__item> <a href=../../core/08-key-programming-vcsec/ class=md-nav__link> <span class=md-ellipsis> Key Programming </span> </a> </li> <li class=md-nav__item> <a href=../../core/13-ota-handshake-protocol/ class=md-nav__link> <span class=md-ellipsis> OTA Protocol </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Gateway Security </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Gateway Security </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gateway/81-gateway-secure-configs-CRITICAL/ class=md-nav__link> <span class=md-ellipsis> üîí CRITICAL: Secure Configs </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/80-ryzen-gateway-flash-COMPLETE/ class=md-nav__link> <span class=md-ellipsis> ‚úÖ Complete Flash Dump </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/82-odin-routines-database-UNHASHED/ class=md-nav__link> <span class=md-ellipsis> üîì Odin Database </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/92-config-metadata-table-FOUND/ class=md-nav__link> <span class=md-ellipsis> üéØ Config Metadata Table </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/83-odin-config-api-analysis/ class=md-nav__link> <span class=md-ellipsis> Odin Config API </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/84-gw-diag-command-reference/ class=md-nav__link> <span class=md-ellipsis> gw-diag Commands </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/88-gateway-strings-analysis/ class=md-nav__link> <span class=md-ellipsis> Gateway Strings </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/91-gateway-powerpc-disassembly-summary/ class=md-nav__link> <span class=md-ellipsis> PowerPC Disassembly </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/94-gateway-ALL-FUNCTIONS/ class=md-nav__link> <span class=md-ellipsis> All Functions </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/95-gateway-CAN-MESSAGES-COMPLETE/ class=md-nav__link> <span class=md-ellipsis> CAN Messages Complete </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/96-gateway-DATA-TABLES/ class=md-nav__link> <span class=md-ellipsis> All Data Tables </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/97-gateway-MEMORY-MAP/ class=md-nav__link> <span class=md-ellipsis> Memory Map </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/98-SHA-256-USAGE-ANALYSIS/ class=md-nav__link> <span class=md-ellipsis> SHA-256 Usage </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/99-gateway-FIRMWARE-METADATA/ class=md-nav__link> <span class=md-ellipsis> Firmware Metadata </span> </a> </li> <li class=md-nav__item> <a href=../../gateway/55-gateway-spc-chip-replacement/ class=md-nav__link> <span class=md-ellipsis> SPC Chip Replacement </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> MCU Research </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> MCU Research </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../mcu/24-mcu-architecture.md class=md-nav__link> <span class=md-ellipsis> MCU Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../mcu/25-mcu-boot-sequence.md class=md-nav__link> <span class=md-ellipsis> Boot Sequence </span> </a> </li> <li class=md-nav__item> <a href=../../mcu/28-mcu-qtcarserver.md class=md-nav__link> <span class=md-ellipsis> QtCarServer Security </span> </a> </li> <li class=md-nav__item> <a href=../../mcu/31-mcu-chromium-security.md class=md-nav__link> <span class=md-ellipsis> Chromium Security </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Evidence & Audit </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Evidence & Audit </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../evidence/59-EVIDENCE-AUDIT/ class=md-nav__link> <span class=md-ellipsis> Evidence Audit </span> </a> </li> <li class=md-nav__item> <a href=../../VERIFICATION-STATUS/ class=md-nav__link> <span class=md-ellipsis> Verification Status </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Tools & Scripts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Tools & Scripts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tools/56-tools-gateway-database-query.md class=md-nav__link> <span class=md-ellipsis> Gateway CRC Validator </span> </a> </li> <li class=md-nav__item> <a href=#scripts class=md-nav__link> <span class=md-ellipsis> Download Scripts </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=tesla-ape-factory-mode-calibration-system-analysis>Tesla APE Factory Mode &amp; Calibration System Analysis</h1> <p><strong>Analysis Date:</strong> 2026-02-03<br> <strong>Target:</strong> Autopilot ECU (APE) - HTTP Server on port 8901<br> <strong>Source:</strong> APE firmware extraction + Odin bundle scripts<br> <strong>Status:</strong> üü° IN PROGRESS - Awaiting deeper binary analysis</p> <hr> <h2 id=executive-summary>Executive Summary</h2> <p>The Tesla Autopilot ECU (APE) exposes a comprehensive HTTP-based factory mode and calibration system on port <strong>8901</strong>. This API provides Tesla service centers with camera calibration capabilities, factory mode controls, and diagnostic endpoints. The system includes 10+ factory_calibration endpoints plus factory mode controls with authentication requirements.</p> <p><strong>Key Security Findings:</strong> - HTTP server on port 8901 requires authenticated requests (bearer tokens) - Factory mode entry/exit controlled via HTTP endpoints, not just fuse checks - Camera calibration system writes to <code>/factory/</code> filesystem paths - Calibration state tracked via sentinel files (<code>.calibration-start</code>, <code>.calibration-complete</code>, etc.) - Factory mode bypasses AppArmor restrictions via <code>unload-apparmor-in-factory</code> - Hard ECU resets required after calibration mode changes</p> <hr> <h2 id=table-of-contents>Table of Contents</h2> <ol> <li><a href=#1-factory-mode-http-endpoints>Factory Mode HTTP Endpoints</a></li> <li><a href=#2-factory-calibration-api>Factory Calibration API</a></li> <li><a href=#3-factory-sentinel-files>Factory Sentinel Files</a></li> <li><a href=#4-authentication--authorization>Authentication &amp; Authorization</a></li> <li><a href=#5-ape-binary-analysis>APE Binary Analysis</a></li> <li><a href=#6-mcu-odin-scripts-integration>MCU Odin Scripts Integration</a></li> <li><a href=#7-calibration-workflow>Calibration Workflow</a></li> <li><a href=#8-security-analysis>Security Analysis</a></li> <li><a href=#9-attack-surface>Attack Surface</a></li> <li><a href=#10-recommendations>Recommendations</a></li> </ol> <hr> <h2 id=1-factory-mode-http-endpoints>1. Factory Mode HTTP Endpoints</h2> <h3 id=11-primary-endpoints>1.1 Primary Endpoints</h3> <p>Located at <code>http://192.168.90.103:8901/</code> (APE-A) and <code>http://192.168.90.105:8901/</code> (APE-B):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>/factory/enter          POST   Enter factory mode
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>/factory/exit           POST   Exit factory mode
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>/board_info/*           GET    Board information endpoints
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>/provisioning/*         GET    Provisioning data
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>/firmware_hash          GET    Current firmware version
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>/status                 GET    ECU status
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>/grablogs               POST   Log retrieval
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>/teleforce/execute      POST   Execute signed TeleForce scripts
</code></pre></div> <p><strong>From Odin scripts:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1># DAS_ENTER_FACTORY_MODE.py</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;http://192.168.90.103:8901/factory/enter&#39;</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=c1># Returns: &quot;Already in factory mode&quot; or &quot;Will switch to factory mode&quot;</span>
</code></pre></div></p> <h3 id=12-factory-mode-state-machine>1.2 Factory Mode State Machine</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>[Normal Operation]
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>        ‚Üì POST /factory/enter
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>[Factory Mode Transition]
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>        ‚Üì (May require UDS ECU reset)
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>[Factory Mode Active]
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>        ‚Üì POST /factory/exit
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>[Normal Operation]
</code></pre></div> <p><strong>States returned by <code>/factory/enter</code>:</strong> - <code>"Already in factory mode"</code> - No action needed - <code>"Will switch to factory mode"</code> - ECU will transition</p> <p><strong>From Odin automation:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1># Common/lib/DAS_ENTER_FACTORY_MODE.py</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=n>enter_calibmode</span> <span class=o>=</span> <span class=k>await</span> <span class=n>http_auth_request</span><span class=p>(</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=n>url</span><span class=o>=</span><span class=s1>&#39;http://192.168.90.103:8901/factory/enter&#39;</span><span class=p>,</span> 
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    <span class=n>method</span><span class=o>=</span><span class=s1>&#39;POST&#39;</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=p>)</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=k>if</span> <span class=n>enter_calibmode</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;response&#39;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;success&#39;</span><span class=p>)</span> <span class=o>!=</span> <span class=s1>&#39;pass&#39;</span><span class=p>:</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    <span class=c1># Failed to enter factory mode</span>
</code></pre></div></p> <hr> <h2 id=2-factory-calibration-api>2. Factory Calibration API</h2> <h3 id=21-complete-endpoint-inventory>2.1 Complete Endpoint Inventory</h3> <p><strong>Base URL:</strong> <code>http://192.168.90.103:8901/factory_calibration/</code></p> <table> <thead> <tr> <th>Endpoint</th> <th>Method</th> <th>Purpose</th> <th>Auth Required</th> <th>Odin Usage</th> </tr> </thead> <tbody> <tr> <td><code>/force_calibration_mode</code></td> <td>GET</td> <td>Enter calibration mode</td> <td>‚úÖ Bearer</td> <td>DAS_ENTER_CALIBRATION_MODE.py</td> </tr> <tr> <td><code>/exit_calibration_mode</code></td> <td>GET</td> <td>Exit calibration mode</td> <td>‚úÖ Bearer</td> <td>DAS_EXIT_CALIBRATION_MODE.py</td> </tr> <tr> <td><code>/status</code></td> <td>GET</td> <td>Get calibration status</td> <td>‚úÖ Bearer</td> <td>DAS_CAMERA_CALIBRATION.py</td> </tr> <tr> <td><code>/start_calibration</code></td> <td>POST</td> <td>Start calibration process</td> <td>‚úÖ Bearer</td> <td>DAS_CAMERA_CALIBRATION.py</td> </tr> <tr> <td><code>/download_calibration</code></td> <td>GET</td> <td>Download calibration data</td> <td>‚úÖ Bearer</td> <td>DAS_CAMERA_CALIBRATION.py</td> </tr> <tr> <td><code>/upload_parameters</code></td> <td>POST</td> <td>Upload calibration params</td> <td>‚úÖ Bearer</td> <td>DAS_CALIBRATION_SETUP.py</td> </tr> <tr> <td><code>/sanitize_parameters</code></td> <td>GET</td> <td>Validate parameters</td> <td>‚úÖ Bearer</td> <td>DAS_CAMERA_CALIBRATION.py</td> </tr> <tr> <td><code>/capture_image</code></td> <td>GET</td> <td>Capture calibration image</td> <td>‚úÖ Bearer</td> <td>PROC_DAS_X_CAPTURE-IMAGE.py</td> </tr> <tr> <td><code>/clear_calibration</code></td> <td>GET</td> <td>Clear camera calibration</td> <td>‚úÖ Bearer</td> <td>DAS_CLEAR_CALIBRATION.py</td> </tr> <tr> <td><code>/cameras_init_done_for_apb</code></td> <td>GET</td> <td>Check camera init status</td> <td>‚ùì</td> <td>backup-camera service</td> </tr> </tbody> </table> <p><strong>Additional endpoints inferred:</strong> - <code>/factory_calibration/factory_eol_image.clip</code> - End-of-line image capture - <code>/factory_calibration/camera_params.json</code> - Camera parameters - <code>/factory_calibration/metrology.json</code> - Metrology data</p> <h3 id=22-calibration-status-response-format>2.2 Calibration Status Response Format</h3> <p><strong>From DAS_CAMERA_CALIBRATION.py:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=n>check_status</span> <span class=o>=</span> <span class=k>await</span> <span class=n>http_auth_request</span><span class=p>(</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    <span class=n>url</span><span class=o>=</span><span class=s1>&#39;http://192.168.90.103:8901/factory_calibration/status&#39;</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=p>)</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=c1># Response format:</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=p>{</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>    <span class=s2>&quot;success&quot;</span><span class=p>:</span> <span class=s2>&quot;pass&quot;</span> <span class=o>|</span> <span class=s2>&quot;failed&quot;</span><span class=p>,</span>  <span class=c1># Overall status</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>    <span class=s2>&quot;status&quot;</span><span class=p>:</span> <span class=s2>&quot;in_progress&quot;</span> <span class=o>|</span> <span class=s2>&quot;not_in_progress&quot;</span> <span class=o>|</span> <span class=s2>&quot;complete&quot;</span><span class=p>,</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    <span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=s2>&quot;Error message if failed&quot;</span><span class=p>,</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>    <span class=s2>&quot;repair&quot;</span><span class=p>:</span> <span class=s2>&quot;Repair instructions if applicable&quot;</span><span class=p>,</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>    <span class=s2>&quot;udsResetRequired&quot;</span><span class=p>:</span> <span class=s2>&quot;yes&quot;</span> <span class=o>|</span> <span class=s2>&quot;no&quot;</span>  <span class=c1># Whether ECU reset needed</span>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=p>}</span>
</code></pre></div></p> <h3 id=23-start-calibration-request>2.3 Start Calibration Request</h3> <p><strong>From DAS_CAMERA_CALIBRATION.py:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=n>start_calibration</span> <span class=o>=</span> <span class=k>await</span> <span class=n>http_auth_request</span><span class=p>(</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>    <span class=n>url</span><span class=o>=</span><span class=s1>&#39;http://192.168.90.103:8901/factory_calibration/start_calibration&#39;</span><span class=p>,</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>    <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;vin&#39;</span><span class=p>:</span> <span class=n>vehicle_vin</span><span class=p>},</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>    <span class=n>timeout</span><span class=o>=</span><span class=mi>120</span>  <span class=c1># 2 minutes - calibration takes time</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=p>)</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=c1># Response:</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=p>{</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>    <span class=s2>&quot;success&quot;</span><span class=p>:</span> <span class=s2>&quot;pass&quot;</span> <span class=o>|</span> <span class=s2>&quot;fail&quot;</span><span class=p>,</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>    <span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=s2>&quot;Details if failed&quot;</span><span class=p>,</span>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>    <span class=s2>&quot;repair&quot;</span><span class=p>:</span> <span class=s2>&quot;Repair actions needed&quot;</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=p>}</span>
</code></pre></div></p> <p><strong>Calibration cameras:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>cameras</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;main&#39;</span><span class=p>,</span> <span class=s1>&#39;narrow&#39;</span><span class=p>,</span> <span class=s1>&#39;fisheye&#39;</span><span class=p>,</span> <span class=s1>&#39;leftpillar&#39;</span><span class=p>,</span> <span class=s1>&#39;rightpillar&#39;</span><span class=p>,</span> 
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>           <span class=s1>&#39;leftrepeater&#39;</span><span class=p>,</span> <span class=s1>&#39;rightrepeater&#39;</span><span class=p>,</span> <span class=s1>&#39;backup&#39;</span><span class=p>]</span>
</code></pre></div></p> <h3 id=24-download-calibration-endpoint>2.4 Download Calibration Endpoint</h3> <p><strong>From DAS_CAMERA_CALIBRATION.py:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>for</span> <span class=n>camera</span> <span class=ow>in</span> <span class=n>cameras</span><span class=p>:</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>    <span class=n>check_camera</span> <span class=o>=</span> <span class=k>await</span> <span class=n>http_auth_request</span><span class=p>(</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>        <span class=n>url</span><span class=o>=</span><span class=s1>&#39;http://192.168.90.103:8901/factory_calibration/download_calibration&#39;</span><span class=p>,</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>        <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;camera&#39;</span><span class=p>:</span> <span class=n>camera</span><span class=p>}</span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>    <span class=p>)</span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>    <span class=c1># Response:</span>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>    <span class=p>{</span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>        <span class=s2>&quot;Calibration_result&quot;</span><span class=p>:</span> <span class=kc>True</span> <span class=o>|</span> <span class=kc>False</span><span class=p>,</span>  <span class=c1># Success/fail per camera</span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>        <span class=c1># Additional calibration data</span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>    <span class=p>}</span>
</code></pre></div></p> <h3 id=25-upload-parameters-endpoint>2.5 Upload Parameters Endpoint</h3> <p><strong>From DAS_CALIBRATION_SETUP.py:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=n>upload</span> <span class=o>=</span> <span class=k>await</span> <span class=n>http_auth_request</span><span class=p>(</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    <span class=n>url</span><span class=o>=</span><span class=s1>&#39;http://192.168.90.103:8901/factory_calibration/upload_parameters&#39;</span><span class=p>,</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    <span class=n>method</span><span class=o>=</span><span class=s1>&#39;POST&#39;</span><span class=p>,</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>    <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;param&#39;</span><span class=p>:</span> <span class=n>param_name</span><span class=p>},</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>    <span class=n>data</span><span class=o>=</span><span class=n>param_string</span>  <span class=c1># Calibration parameter data</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=p>)</span>
</code></pre></div></p> <hr> <h2 id=3-factory-sentinel-files>3. Factory Sentinel Files</h2> <h3 id=31-calibration-state-files>3.1 Calibration State Files</h3> <p><strong>From <code>factory_camera_calibration</code> binary strings:</strong></p> <p>Located in <code>/factory/</code> directory on APE:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>/factory/.calibration-start         # Calibration started
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>/factory/.calibration-in-progress   # Currently calibrating
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>/factory/.calibration-complete      # Calibration succeeded
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>/factory/.calibration-failed        # Calibration failed
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>/factory/.service-mode-clip-capture # Service mode capture flag
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>/factory/calibration_camera_params.json    # Camera parameters
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>/factory/calibration_metrology.json        # Metrology parameters
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>/factory/factory_eol_image.clip            # End-of-line image
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>/factory/factory_eol_calibration_&lt;timestamp&gt;  # Calibration data
</code></pre></div> <p><strong>Purpose:</strong> Track calibration state across ECU reboots and provide factory mode indicators.</p> <h3 id=32-factory-mode-detection>3.2 Factory Mode Detection</h3> <p><strong>Binary:</strong> <code>/usr/bin/is-in-factory</code> (Shell script)</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=ch>#!/bin/sh</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=c1># Read ODM fuse (blown at end of manufacturing)</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=nv>ODM_PATH</span><span class=o>=</span><span class=s2>&quot;/sys/devices/3820000.efuse/odm_production_mode&quot;</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=nv>BOOT_SEC_INFO_PATH</span><span class=o>=</span><span class=s2>&quot;/sys/devices/3820000.efuse/boot_sec_info&quot;</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=c1># Check if ODM fuse is blown</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=nv>ODM</span><span class=o>=</span><span class=k>$(</span>read_fuse<span class=w> </span><span class=nv>$ODM_PATH</span><span class=k>)</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=nv>BOOT_SEC_INFO</span><span class=o>=</span><span class=k>$(</span>read_fuse<span class=w> </span><span class=nv>$BOOT_SEC_INFO_PATH</span><span class=k>)</span>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=c1># Support emulating a blown ODM fuse for testing</span>
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=nv>ODM_FUSE_SENTINEL</span><span class=o>=</span>/var/lib/board_creds/odm_fuse_sentinel
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=k>if</span><span class=w> </span><span class=o>[</span><span class=w> </span><span class=s2>&quot;</span><span class=nv>$ODM</span><span class=s2>&quot;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;0x00000000&quot;</span><span class=w> </span><span class=o>]</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>[</span><span class=w> </span>!<span class=w> </span>-e<span class=w> </span><span class=nv>$ODM_FUSE_SENTINEL</span><span class=w> </span><span class=o>]</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=k>then</span>
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>[</span><span class=w> </span><span class=s2>&quot;</span><span class=nv>$BOOT_SEC_INFO</span><span class=s2>&quot;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;0x00000000&quot;</span><span class=w> </span><span class=o>]</span><span class=p>;</span><span class=w> </span><span class=k>then</span>
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=w>        </span><span class=nb>exit</span><span class=w> </span><span class=m>0</span><span class=w>  </span><span class=c1># Not fused - factory mode allowed</span>
<a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=w>    </span><span class=k>fi</span>
<a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=k>fi</span>
<a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=nb>exit</span><span class=w> </span><span class=m>1</span><span class=w>  </span><span class=c1># Fused - factory mode blocked</span>
</code></pre></div> <p><strong>Key Finding:</strong> Factory mode detection relies on eFuse + sentinel file. A sentinel file can <strong>override</strong> the eFuse check for testing purposes.</p> <h3 id=33-apparmor-bypass>3.3 AppArmor Bypass</h3> <p><strong>Binary:</strong> <code>/sbin/unload-apparmor-in-factory</code></p> <p>Purpose: Disable AppArmor profiles when in factory mode to allow unrestricted access.</p> <p><strong>Security Implication:</strong> Factory mode = full system access, no sandboxing.</p> <hr> <h2 id=4-authentication-authorization>4. Authentication &amp; Authorization</h2> <h3 id=41-bearer-token-authentication>4.1 Bearer Token Authentication</h3> <p><strong>All</strong> factory_calibration endpoints require authenticated requests with bearer tokens.</p> <p><strong>From Odin scripts:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=n>request_header</span> <span class=o>=</span> <span class=k>await</span> <span class=n>api</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>bearer_token_header</span><span class=p>()</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=n>token</span> <span class=o>=</span> <span class=n>request_header</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;header&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>http_auth_request</span><span class=p>(</span>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>    <span class=n>headers</span><span class=o>=</span><span class=n>token</span><span class=p>,</span> 
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>    <span class=n>method</span><span class=o>=</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> 
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>    <span class=n>url</span><span class=o>=</span><span class=s1>&#39;http://192.168.90.103:8901/factory_calibration/status&#39;</span>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=p>)</span>
</code></pre></div></p> <p><strong>Token Generation:</strong> Tokens are generated by the MCU (not APE) using service credentials signed by Tesla's backend.</p> <p><strong>Reference:</strong> See <a href=20-service-mode-authentication.md>20-service-mode-authentication.md</a> for signed command infrastructure.</p> <h3 id=42-fuse-based-gating>4.2 Fuse-Based Gating</h3> <p><strong>From Odin SET_FACTORY_MODE_GTW_UI.py:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=n>is_fused</span> <span class=o>=</span> <span class=n>api</span><span class=o>.</span><span class=n>cid</span><span class=o>.</span><span class=n>is_fused</span><span class=p>()</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=k>if</span> <span class=n>is_fused</span><span class=p>[</span><span class=s1>&#39;is_fused&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=n>factory_mode</span><span class=p>:</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>    <span class=c1># &quot;Car is fused, we should not be entering factory mode&quot;</span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>    <span class=k>return</span> <span class=n>FAIL</span>
</code></pre></div></p> <p><strong>Factory mode is blocked on production vehicles</strong> unless: 1. eFuse shows unfused state (<code>0x00000000</code>) 2. OR sentinel file <code>/var/lib/board_creds/odm_fuse_sentinel</code> exists 3. AND valid service credentials provided</p> <h3 id=43-authentication-flow>4.3 Authentication Flow</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>User triggers factory mode (Odin)
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>        ‚Üì
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>MCU generates signed command token
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>        ‚Üì
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>MCU sends authenticated HTTP request to APE:8901/factory/enter
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>        ‚Üì
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>APE validates token (verifies signature)
<a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>        ‚Üì
<a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>APE checks is-in-factory (eFuse + sentinel)
<a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a>        ‚Üì
<a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>APE transitions to factory mode OR rejects
</code></pre></div> <hr> <h2 id=5-ape-binary-analysis>5. APE Binary Analysis</h2> <h3 id=51-binaries-identified>5.1 Binaries Identified</h3> <p><strong>‚úÖ Port 8901 HTTP Server:</strong> <code>/usr/bin/service_api</code> (Go binary, stripped)</p> <p><strong>Factory Calibration:</strong> <code>/opt/autopilot/bin/factory_camera_calibration</code> (3.1MB ARM64 ELF, C++)</p> <p><strong>Field Calibration:</strong> <code>/opt/autopilot/bin/field_calibration</code> (1.2MB ARM64 ELF, C++)</p> <p><strong>UI Server:</strong> <code>/opt/autopilot/bin/ui_server</code> (1.3MB ARM64 ELF, C++ with WebSocket++)</p> <p><strong>From strings analysis:</strong> - <code>service_api</code> is the <strong>HTTP server for port 8901</strong> (confirmed via strings) - <code>factory_camera_calibration</code> contains all <code>/factory/</code> path references - <code>ui_server</code> handles WebSocket connections (separate from 8901) - All binaries are <strong>stripped</strong> - no function symbols available</p> <h3 id=52-service_api-http-server-implementation>5.2 service_api HTTP Server Implementation</h3> <p><strong>Binary:</strong> <code>/usr/bin/service_api</code> (Go binary, BuildID: <code>PxA5DeuNJjbwZ4d_W7Hn</code>)</p> <p><strong>Language:</strong> Go (confirmed by BuildID and string patterns)</p> <p><strong>Service launch script:</strong> <code>/etc/sv/service-api/run</code> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=ch>#!/bin/sh</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=c1># Rate limiting if NOT in factory mode</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=k>if</span><span class=w> </span>!<span class=w> </span>/usr/bin/is-in-factory<span class=p>;</span><span class=w> </span><span class=k>then</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>    </span><span class=nv>ARGS</span><span class=o>=</span><span class=s2>&quot;</span><span class=nv>$ARGS</span><span class=s2> --requests-per-second 10 --requests-max-burst 10&quot;</span>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=k>fi</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=c1># Disable AppArmor in factory mode</span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>/sbin/unload-apparmor-in-factory
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>
<a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=c1># Launch service API</span>
<a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=nb>exec</span><span class=w> </span>/usr/bin/service_api<span class=w> </span><span class=nv>$ARGS</span>
</code></pre></div></p> <p><strong>Port 8901 confirmed:</strong> String extraction shows <code>:8901</code> hardcoded in binary</p> <p><strong>Key findings from strings:</strong> 1. <strong>Endpoints hardcoded:</strong> - <code>/factory/enter</code> - <code>/factory/exit</code> - <code>/factory_calibration/status</code> - <code>/factory_calibration/start_calibration</code> - <code>/factory_calibration/clear_calibration</code> - <code>/factory_calibration/capture_image</code> - <code>/factory_calibration/upload_calibration</code> - <code>/factory_calibration/download_calibration</code> - <code>/factory_calibration/capture_raw_frames</code> - <code>/factory_calibration/upload_parameters</code> - <code>/factory_calibration/clear_parameters</code> - <code>/factory_calibration/clear_state</code> - <code>/board_info/*</code> endpoints - <code>/provisioning/*</code> endpoints - <code>/fuse/*</code> endpoints - <code>/vision/clear_calibration</code> - <code>/selftest/*</code> endpoints</p> <ol> <li> <p><strong>Authentication:</strong> Bearer token validation (<code>:http</code> header handling)</p> </li> <li> <p><strong>Factory mode detection:</strong> Calls <code>/usr/bin/is-in-factory</code> script</p> </li> <li> <p><strong>Rate limiting:</strong></p> </li> <li>Normal mode: 10 requests/second with burst of 10</li> <li> <p>Factory mode: <strong>No rate limiting</strong></p> </li> <li> <p><strong>Response messages found:</strong></p> </li> <li><code>"Already in factory mode"</code></li> <li><code>"Not in calibration mode"</code></li> <li><code>"Request ignored. Not in factory mode"</code></li> <li> <p><code>"factory mode detected, ignoring request"</code></p> </li> <li> <p><strong>Error handling:</strong></p> </li> <li><code>"failed to create factory mode file: %s"</code></li> <li><code>"failed to delete factory mode file: %s"</code></li> <li><code>"reboot request from clear calibration"</code></li> <li> <p><code>"requesting system reboot via UDS reset"</code></p> </li> <li> <p><strong>Calibration state tracking:</strong></p> </li> <li><code>/factory/.calibration-start</code></li> <li><code>/factory/.calibration-in-progress</code></li> <li><code>/factory/.calibration-complete</code></li> <li><code>/factory/.calibration-failed</code></li> <li><code>/factory/.service-mode-capture-raw</code></li> <li> <p><code>/factory/.service-mode-clip-capture</code></p> </li> <li> <p><strong>VIN validation:</strong> </p> </li> <li><code>"vin identifer set: %s"</code></li> <li> <p>Requires VIN for calibration start</p> </li> <li> <p><strong>Camera identification:</strong></p> </li> <li><code>"Invalid camera: %s"</code></li> <li><code>"%s is not a valid camera id"</code></li> <li>Validates camera names before operations</li> </ol> <p><strong>Security features:</strong> - <strong>AppArmor bypass:</strong> Calls <code>/sbin/unload-apparmor-in-factory</code> (security weakness) - <strong>Fuse check:</strong> Uses <code>/usr/bin/is-in-factory</code> to verify production status - <strong>Rate limiting:</strong> Applied outside factory mode only - <strong>Request validation:</strong> Checks factory mode state before allowing operations</p> <h3 id=53-factory-calibration-binary-strings>5.3 Factory Calibration Binary Strings</h3> <p><strong>From factory_camera_calibration:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>/factory/.calibration-complete
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>/factory/.service-mode-clip-capture
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>/factory/.calibration-start
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>/factory/calibration_camera_params.json
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>/factory/factory_eol_image.clip
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>/factory/.calibration-failed
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>/factory/.calibration-in-progress
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>/factory/calibration_metrology.json
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>text_log_httpservertask
</code></pre></div></p> <p><strong>Dependency:</strong> Uses OpenCV for image processing: <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>OpenCV/MatExpr: processing of multi-channel arrays might be changed...
</code></pre></div></p> <p><strong>Source code references:</strong> <code>common/tasks/factory_camera_calibration/*.cpp</code> (build paths leaked)</p> <h3 id=54-factory-mode-state-machine-service_api>5.4 Factory Mode State Machine (service_api)</h3> <p><strong>From service_api binary strings, complete state machine:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>‚îÇ         FACTORY MODE STATE MACHINE              ‚îÇ
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>[Production Vehicle - Fuse Blown]
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>        ‚îÇ
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>        ‚îú‚îÄ is-in-factory check FAILS
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>        ‚îÇ  ‚Üí All factory endpoints return 403 or ignored
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>        ‚îÇ
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>        ‚îî‚îÄ Sentinel override exists?
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a>           ‚Üí /var/lib/board_creds/odm_fuse_sentinel
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a>              ‚îú‚îÄ YES ‚Üí Allow factory mode (testing)
<a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a>              ‚îî‚îÄ NO  ‚Üí Block factory mode
<a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a>
<a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a>[Unfused Vehicle OR Sentinel Present]
<a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a>        ‚îÇ
<a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a>        ‚îú‚îÄ POST /factory/enter (authenticated)
<a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a>        ‚îÇ  ‚îú‚îÄ Already in factory? ‚Üí &quot;Already in factory mode&quot;
<a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a>        ‚îÇ  ‚îú‚îÄ Not in factory? ‚Üí &quot;Will switch to factory mode&quot;
<a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a>        ‚îÇ  ‚îÇ   ‚îú‚îÄ Create factory mode sentinel file
<a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a>        ‚îÇ  ‚îÇ   ‚îú‚îÄ Call /sbin/unload-apparmor-in-factory
<a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a>        ‚îÇ  ‚îÇ   ‚îî‚îÄ Disable rate limiting
<a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a>        ‚îÇ  ‚îî‚îÄ Return success
<a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a>        ‚îÇ
<a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a>        ‚îú‚îÄ [Factory Mode Active]
<a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a>        ‚îÇ  ‚îú‚îÄ Rate limiting: DISABLED
<a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a>        ‚îÇ  ‚îú‚îÄ AppArmor: DISABLED  
<a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a>        ‚îÇ  ‚îú‚îÄ Factory endpoints: ENABLED
<a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a>        ‚îÇ  ‚îÇ
<a id=__codelineno-17-30 name=__codelineno-17-30 href=#__codelineno-17-30></a>        ‚îÇ  ‚îú‚îÄ GET /factory_calibration/force_calibration_mode
<a id=__codelineno-17-31 name=__codelineno-17-31 href=#__codelineno-17-31></a>        ‚îÇ  ‚îÇ  ‚îú‚îÄ Check if cameras initialized
<a id=__codelineno-17-32 name=__codelineno-17-32 href=#__codelineno-17-32></a>        ‚îÇ  ‚îÇ  ‚îú‚îÄ Create /factory/.calibration-start
<a id=__codelineno-17-33 name=__codelineno-17-33 href=#__codelineno-17-33></a>        ‚îÇ  ‚îÇ  ‚îú‚îÄ May require UDS ECU reset
<a id=__codelineno-17-34 name=__codelineno-17-34 href=#__codelineno-17-34></a>        ‚îÇ  ‚îÇ  ‚îî‚îÄ Enter calibration mode
<a id=__codelineno-17-35 name=__codelineno-17-35 href=#__codelineno-17-35></a>        ‚îÇ  ‚îÇ
<a id=__codelineno-17-36 name=__codelineno-17-36 href=#__codelineno-17-36></a>        ‚îÇ  ‚îú‚îÄ [Calibration Mode Active]
<a id=__codelineno-17-37 name=__codelineno-17-37 href=#__codelineno-17-37></a>        ‚îÇ  ‚îÇ  ‚îú‚îÄ POST /factory_calibration/start_calibration?vin=&lt;VIN&gt;
<a id=__codelineno-17-38 name=__codelineno-17-38 href=#__codelineno-17-38></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ Create /factory/.calibration-in-progress
<a id=__codelineno-17-39 name=__codelineno-17-39 href=#__codelineno-17-39></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ Run camera calibration algorithms
<a id=__codelineno-17-40 name=__codelineno-17-40 href=#__codelineno-17-40></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ Capture images from all 8 cameras
<a id=__codelineno-17-41 name=__codelineno-17-41 href=#__codelineno-17-41></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ Calculate parameters (OpenCV)
<a id=__codelineno-17-42 name=__codelineno-17-42 href=#__codelineno-17-42></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ Write /factory/calibration_camera_params.json
<a id=__codelineno-17-43 name=__codelineno-17-43 href=#__codelineno-17-43></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ Write /factory/calibration_metrology.json
<a id=__codelineno-17-44 name=__codelineno-17-44 href=#__codelineno-17-44></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ Create /factory/.calibration-complete (or .calibration-failed)
<a id=__codelineno-17-45 name=__codelineno-17-45 href=#__codelineno-17-45></a>        ‚îÇ  ‚îÇ  ‚îÇ
<a id=__codelineno-17-46 name=__codelineno-17-46 href=#__codelineno-17-46></a>        ‚îÇ  ‚îÇ  ‚îú‚îÄ GET /factory_calibration/status
<a id=__codelineno-17-47 name=__codelineno-17-47 href=#__codelineno-17-47></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ Return {&quot;success&quot;: &quot;pass/failed&quot;, &quot;status&quot;: &quot;in_progress/complete&quot;}
<a id=__codelineno-17-48 name=__codelineno-17-48 href=#__codelineno-17-48></a>        ‚îÇ  ‚îÇ  ‚îÇ
<a id=__codelineno-17-49 name=__codelineno-17-49 href=#__codelineno-17-49></a>        ‚îÇ  ‚îÇ  ‚îú‚îÄ GET /factory_calibration/download_calibration?camera=&lt;name&gt;
<a id=__codelineno-17-50 name=__codelineno-17-50 href=#__codelineno-17-50></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ Return calibration data for specific camera
<a id=__codelineno-17-51 name=__codelineno-17-51 href=#__codelineno-17-51></a>        ‚îÇ  ‚îÇ  ‚îÇ
<a id=__codelineno-17-52 name=__codelineno-17-52 href=#__codelineno-17-52></a>        ‚îÇ  ‚îÇ  ‚îú‚îÄ GET /factory_calibration/exit_calibration_mode
<a id=__codelineno-17-53 name=__codelineno-17-53 href=#__codelineno-17-53></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ Remove /factory/.calibration-in-progress
<a id=__codelineno-17-54 name=__codelineno-17-54 href=#__codelineno-17-54></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ May require UDS ECU reset
<a id=__codelineno-17-55 name=__codelineno-17-55 href=#__codelineno-17-55></a>        ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ Exit calibration mode
<a id=__codelineno-17-56 name=__codelineno-17-56 href=#__codelineno-17-56></a>        ‚îÇ  ‚îÇ  ‚îÇ
<a id=__codelineno-17-57 name=__codelineno-17-57 href=#__codelineno-17-57></a>        ‚îÇ  ‚îÇ  ‚îî‚îÄ GET /vision/clear_calibration?camera=&lt;name&gt;
<a id=__codelineno-17-58 name=__codelineno-17-58 href=#__codelineno-17-58></a>        ‚îÇ  ‚îÇ     ‚îú‚îÄ Delete calibration data for camera
<a id=__codelineno-17-59 name=__codelineno-17-59 href=#__codelineno-17-59></a>        ‚îÇ  ‚îÇ     ‚îî‚îÄ Requires UDS reset after
<a id=__codelineno-17-60 name=__codelineno-17-60 href=#__codelineno-17-60></a>        ‚îÇ  ‚îÇ
<a id=__codelineno-17-61 name=__codelineno-17-61 href=#__codelineno-17-61></a>        ‚îÇ  ‚îî‚îÄ POST /factory/exit
<a id=__codelineno-17-62 name=__codelineno-17-62 href=#__codelineno-17-62></a>        ‚îÇ     ‚îú‚îÄ Delete factory mode sentinel file
<a id=__codelineno-17-63 name=__codelineno-17-63 href=#__codelineno-17-63></a>        ‚îÇ     ‚îú‚îÄ Reload AppArmor profiles
<a id=__codelineno-17-64 name=__codelineno-17-64 href=#__codelineno-17-64></a>        ‚îÇ     ‚îú‚îÄ Re-enable rate limiting
<a id=__codelineno-17-65 name=__codelineno-17-65 href=#__codelineno-17-65></a>        ‚îÇ     ‚îî‚îÄ &quot;Factory mode exit successful&quot;
<a id=__codelineno-17-66 name=__codelineno-17-66 href=#__codelineno-17-66></a>        ‚îÇ
<a id=__codelineno-17-67 name=__codelineno-17-67 href=#__codelineno-17-67></a>        ‚îî‚îÄ [Normal Operation]
</code></pre></div> <p><strong>Critical State Files:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1># Factory mode active</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>/var/lib/board_creds/odm_fuse_sentinel<span class=w>  </span><span class=c1># Override fuse check (optional)</span>
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>/factory/.in-factory<span class=w>                     </span><span class=c1># Factory mode active marker (inferred)</span>
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=c1># Calibration state</span>
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>/factory/.calibration-start<span class=w>              </span><span class=c1># Calibration initiated</span>
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>/factory/.calibration-in-progress<span class=w>        </span><span class=c1># Currently calibrating</span>
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>/factory/.calibration-complete<span class=w>           </span><span class=c1># Success</span>
<a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a>/factory/.calibration-failed<span class=w>             </span><span class=c1># Failure</span>
<a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a>
<a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=c1># Calibration data</span>
<a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a>/factory/calibration_camera_params.json<span class=w>  </span><span class=c1># Camera parameters</span>
<a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a>/factory/calibration_metrology.json<span class=w>      </span><span class=c1># Metrology data</span>
<a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a>/factory/factory_eol_calibration_&lt;timestamp&gt;<span class=w>  </span><span class=c1># EOL calibration</span>
<a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a>/factory/factory_eol_image.clip<span class=w>          </span><span class=c1># End-of-line image</span>
<a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a>
<a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=c1># Service mode capture</span>
<a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a>/factory/.service-mode-clip-capture<span class=w>      </span><span class=c1># Service mode capture flag</span>
<a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a>/factory/.service-mode-capture-raw<span class=w>       </span><span class=c1># Raw capture mode</span>
</code></pre></div></p> <p><strong>UDS Reset Trigger Points:</strong> 1. After entering calibration mode (if <code>udsResetRequired: "yes"</code>) 2. After exiting calibration mode (if <code>udsResetRequired: "yes"</code>) 3. After clearing calibration data 4. Explicit reboot requests: <code>"reboot request from clear calibration"</code></p> <p><strong>Rate Limiting Bypass:</strong> - Factory mode: <strong>NO rate limiting</strong> - Normal mode: 10 req/s with burst of 10 - Allows intensive calibration operations without throttling</p> <h3 id=55-service-manager-integration>5.5 Service Manager Integration</h3> <p><strong>Runit services found:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>/etc/sv/factory-camera-calibration/
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>/etc/sv/field-calibration/
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>/etc/sv/backup-camera/run  # Checks cameras_init_done_for_apb endpoint
</code></pre></div></p> <p><strong>From backup-camera service:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=k>while</span><span class=w> </span><span class=o>[</span><span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>curl<span class=w> </span>--max-time<span class=w> </span><span class=m>1</span><span class=w> </span>--silent<span class=w> </span>http://ap:8901/board_info/cameras_init_done_for_apb<span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>!<span class=o>=</span><span class=w> </span><span class=s2>&quot;exists&quot;</span><span class=w> </span><span class=o>]</span><span class=p>;</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=k>do</span>
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=w>    </span>sleep<span class=w> </span><span class=m>1</span>
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=k>done</span>
</code></pre></div></p> <p><strong>Indicates:</strong> APE HTTP server is critical infrastructure, used by system services for init checks.</p> <hr> <h2 id=6-mcu-odin-scripts-integration>6. MCU Odin Scripts Integration</h2> <h3 id=61-factory-mode-entry-script>6.1 Factory Mode Entry Script</h3> <p><strong>File:</strong> <code>Common/lib/DAS_ENTER_FACTORY_MODE.py</code></p> <p><strong>Flow:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=mf>1.</span> <span class=n>POST</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=mf>192.168.90.103</span><span class=p>:</span><span class=mi>8901</span><span class=o>/</span><span class=n>factory</span><span class=o>/</span><span class=n>enter</span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=mf>2.</span> <span class=n>Check</span> <span class=n>response</span><span class=p>:</span> <span class=s2>&quot;Already in factory mode&quot;</span> <span class=ow>or</span> <span class=s2>&quot;Will switch to factory mode&quot;</span>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=mf>3.</span> <span class=n>If</span> <span class=n>switching</span><span class=p>,</span> <span class=n>wait</span> <span class=k>for</span> <span class=n>ECU</span> <span class=n>to</span> <span class=n>transition</span>
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=mf>4.</span> <span class=n>If</span> <span class=n>response</span> <span class=n>indicates</span> <span class=n>UDS</span> <span class=n>reset</span> <span class=n>required</span><span class=p>:</span>
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>   <span class=o>-</span> <span class=n>Send</span> <span class=n>UDS</span> <span class=n>HardReset</span> <span class=n>command</span> <span class=n>to</span> <span class=n>DAS</span> <span class=n>ECU</span>
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>   <span class=o>-</span> <span class=n>Wait</span> <span class=mi>10</span> <span class=n>seconds</span> <span class=k>for</span> <span class=n>APE</span> <span class=n>to</span> <span class=n>boot</span>
<a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=mf>5.</span> <span class=n>Return</span> <span class=n>success</span><span class=o>/</span><span class=n>failure</span>
</code></pre></div></p> <h3 id=62-calibration-mode-entry>6.2 Calibration Mode Entry</h3> <p><strong>File:</strong> <code>Common/lib/DAS_ENTER_CALIBRATION_MODE.py</code></p> <p><strong>Flow:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=mf>1.</span> <span class=n>GET</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=mf>192.168.90.103</span><span class=p>:</span><span class=mi>8901</span><span class=o>/</span><span class=n>factory_calibration</span><span class=o>/</span><span class=n>force_calibration_mode</span>
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=mf>2.</span> <span class=n>Parse</span> <span class=n>response</span><span class=p>:</span>
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>   <span class=p>{</span>
<a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a>       <span class=s2>&quot;success&quot;</span><span class=p>:</span> <span class=s2>&quot;pass&quot;</span><span class=p>,</span>
<a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a>       <span class=s2>&quot;status&quot;</span><span class=p>:</span> <span class=s2>&quot;...&quot;</span><span class=p>,</span>
<a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a>       <span class=s2>&quot;udsResetRequired&quot;</span><span class=p>:</span> <span class=s2>&quot;yes&quot;</span> <span class=o>|</span> <span class=s2>&quot;no&quot;</span>
<a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a>   <span class=p>}</span>
<a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=mf>3.</span> <span class=n>If</span> <span class=n>udsResetRequired</span> <span class=o>==</span> <span class=s2>&quot;yes&quot;</span><span class=p>:</span>
<a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a>   <span class=o>-</span> <span class=n>Wait</span> <span class=n>configured</span> <span class=n>delay</span> <span class=p>(</span><span class=n>default</span> <span class=mi>7</span><span class=n>s</span><span class=p>)</span>
<a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a>   <span class=o>-</span> <span class=n>Send</span> <span class=n>UDS</span> <span class=n>Hard</span> <span class=n>Reset</span> <span class=n>to</span> <span class=n>DAS</span>
<a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a>   <span class=o>-</span> <span class=n>Wait</span> <span class=mi>10</span><span class=n>s</span> <span class=k>for</span> <span class=n>boot</span>
<a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=mf>4.</span> <span class=n>Calibration</span> <span class=n>mode</span> <span class=n>active</span>
</code></pre></div></p> <h3 id=63-camera-calibration-workflow>6.3 Camera Calibration Workflow</h3> <p><strong>File:</strong> <code>Common/lib/DAS_CAMERA_CALIBRATION.py</code></p> <p><strong>Complete flow:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=mf>1.</span> <span class=n>Enter</span> <span class=n>calibration</span> <span class=n>mode</span> <span class=p>(</span><span class=n>DAS_ENTER_CALIBRATION_MODE</span><span class=p>)</span>
<a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=mf>2.</span> <span class=n>Sanitize</span> <span class=n>parameters</span><span class=p>:</span>
<a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>   <span class=n>GET</span> <span class=o>/</span><span class=n>factory_calibration</span><span class=o>/</span><span class=n>sanitize_parameters</span>
<a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=mf>3.</span> <span class=n>Start</span> <span class=n>calibration</span> <span class=p>(</span><span class=k>with</span> <span class=n>VIN</span><span class=p>):</span>
<a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a>   <span class=n>POST</span> <span class=o>/</span><span class=n>factory_calibration</span><span class=o>/</span><span class=n>start_calibration</span><span class=err>?</span><span class=n>vin</span><span class=o>=&lt;</span><span class=n>VIN</span><span class=o>&gt;</span>
<a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=mf>4.</span> <span class=n>Poll</span> <span class=n>status</span> <span class=n>every</span> <span class=mi>1</span><span class=n>s</span> <span class=p>(</span><span class=nb>max</span> <span class=mi>2500</span><span class=n>s</span> <span class=n>timeout</span><span class=p>):</span>
<a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a>   <span class=n>GET</span> <span class=o>/</span><span class=n>factory_calibration</span><span class=o>/</span><span class=n>status</span>
<a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a>   <span class=n>Until</span> <span class=n>status</span> <span class=o>!=</span> <span class=s2>&quot;in_progress&quot;</span>
<a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=mf>5.</span> <span class=n>For</span> <span class=n>each</span> <span class=n>camera</span><span class=p>:</span>
<a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a>   <span class=n>GET</span> <span class=o>/</span><span class=n>factory_calibration</span><span class=o>/</span><span class=n>download_calibration</span><span class=err>?</span><span class=n>camera</span><span class=o>=&lt;</span><span class=n>camera_name</span><span class=o>&gt;</span>
<a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=mf>6.</span> <span class=n>Exit</span> <span class=n>calibration</span> <span class=n>mode</span> <span class=p>(</span><span class=n>DAS_EXIT_CALIBRATION_MODE</span><span class=p>)</span>
</code></pre></div></p> <p><strong>Timeout:</strong> 2500 seconds (41 minutes) - calibration is a <strong>long</strong> operation.</p> <p><strong>Cameras calibrated:</strong> main, narrow, fisheye, leftpillar, rightpillar, leftrepeater, rightrepeater, backup (8 total)</p> <h3 id=64-image-capture-script>6.4 Image Capture Script</h3> <p><strong>File:</strong> <code>Common/scripts/PROC_DAS_X_CAPTURE-IMAGE.py</code></p> <p><strong>Purpose:</strong> Capture diagnostic images from cameras during calibration.</p> <p><strong>Flow:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=mf>1.</span> <span class=n>Turn</span> <span class=n>on</span> <span class=n>ACC</span> <span class=n>rail</span> <span class=p>(</span><span class=n>wake</span> <span class=n>APE</span><span class=p>)</span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=mf>2.</span> <span class=n>Ping</span> <span class=n>APE</span> <span class=n>to</span> <span class=n>verify</span> <span class=n>communication</span>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=mf>3.</span> <span class=n>Enter</span> <span class=n>calibration</span> <span class=n>mode</span>
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=mf>4.</span> <span class=n>Capture</span> <span class=n>image</span><span class=p>:</span>
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>   <span class=n>GET</span> <span class=o>/</span><span class=n>factory_calibration</span><span class=o>/</span><span class=n>capture_image</span>
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>   <span class=n>Download</span> <span class=n>to</span> <span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>odin</span><span class=o>/</span><span class=n>capture</span><span class=o>.</span><span class=n>raw</span>
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=mf>5.</span> <span class=n>Convert</span> <span class=n>RAW</span> <span class=n>to</span> <span class=n>JPEG</span> <span class=p>(</span><span class=n>save_image</span> <span class=n>API</span><span class=p>)</span>
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=mf>6.</span> <span class=n>Exit</span> <span class=n>calibration</span> <span class=n>mode</span>
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=mf>7.</span> <span class=n>Return</span> <span class=n>JPEG</span> <span class=k>as</span> <span class=n>base64</span> <span class=n>to</span> <span class=n>Odin</span> <span class=n>UI</span>
</code></pre></div></p> <p><strong>Image path:</strong> <code>/tmp/odin/capture.raw</code> ‚Üí <code>/tmp/odin/image.jpeg</code></p> <p><strong>Failure handling:</strong> Checks active AP alerts (camera init faults) if capture fails.</p> <h3 id=65-clear-calibration-script>6.5 Clear Calibration Script</h3> <p><strong>File:</strong> <code>Common/scripts/DAS_CLEAR_CALIBRATION.py</code></p> <p><strong>Purpose:</strong> Clear camera calibration data (factory reset cameras).</p> <p><strong>Endpoints used:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a>http://192.168.90.103:8901/vision/clear_calibration?camera=&lt;camera_name&gt;
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>http://192.168.90.105:8901/vision/clear_calibration?camera=&lt;camera_name&gt;
</code></pre></div></p> <p><strong>Camera groups:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=n>CAMERAS_INPUT_KEY_MAP</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>    <span class=s1>&#39;ForwardFacing&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;main&#39;</span><span class=p>,</span> <span class=s1>&#39;narrow&#39;</span><span class=p>,</span> <span class=s1>&#39;fisheye&#39;</span><span class=p>],</span>
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>    <span class=s1>&#39;Repeaters&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;leftrepeater&#39;</span><span class=p>,</span> <span class=s1>&#39;rightrepeater&#39;</span><span class=p>],</span>
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a>    <span class=s1>&#39;BPillars&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;leftpillar&#39;</span><span class=p>,</span> <span class=s1>&#39;rightpillar&#39;</span><span class=p>],</span>
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a>    <span class=s1>&#39;RearView&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;backup&#39;</span><span class=p>],</span>
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a>    <span class=s1>&#39;All&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;all&#39;</span><span class=p>]</span>  <span class=c1># Special value to clear all</span>
<a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=p>}</span>
</code></pre></div></p> <p><strong>Post-clear action:</strong> Hard reset DAS ECU required to reload calibration values.</p> <hr> <h2 id=7-calibration-workflow>7. Calibration Workflow</h2> <h3 id=71-end-to-end-calibration-process>7.1 End-to-End Calibration Process</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>‚îÇ                  TESLA APE CALIBRATION FLOW                   ‚îÇ
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a>‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a>[Odin Service Tool]
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a>        ‚Üì 1. Authenticate with Tesla backend
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a>[MCU] Get bearer token
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a>        ‚Üì 2. Check fuse status (is-in-factory)
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a>[APE] Verify unfused or sentinel present
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a>        ‚Üì 3. POST /factory/enter
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a>[APE] Enter factory mode (disable AppArmor)
<a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a>        ‚Üì 4. GET /factory_calibration/force_calibration_mode
<a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a>[APE] Create /factory/.calibration-start
<a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a>        ‚Üì 5. (Optional) UDS Hard Reset
<a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a>[APE] Reboot into calibration mode
<a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a>        ‚Üì 6. GET /factory_calibration/sanitize_parameters
<a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a>[APE] Validate configuration
<a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a>        ‚Üì 7. POST /factory_calibration/start_calibration?vin=&lt;VIN&gt;
<a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a>[APE] Begin camera calibration routine
<a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a>        ‚îÇ Create /factory/.calibration-in-progress
<a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a>        ‚îÇ Capture images from 8 cameras
<a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a>        ‚îÇ Run computer vision algorithms (OpenCV)
<a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a>        ‚îÇ Calculate calibration parameters
<a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a>        ‚Üì (Poll status every 1s, up to 41 minutes)
<a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a>[APE] Calibration complete
<a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a>        ‚îÇ Write /factory/calibration_camera_params.json
<a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a>        ‚îÇ Write /factory/calibration_metrology.json
<a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a>        ‚îÇ Create /factory/.calibration-complete (or .calibration-failed)
<a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a>        ‚Üì 8. GET /factory_calibration/download_calibration (per camera)
<a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a>[Odin] Verify calibration results
<a id=__codelineno-27-31 name=__codelineno-27-31 href=#__codelineno-27-31></a>        ‚Üì 9. GET /factory_calibration/exit_calibration_mode
<a id=__codelineno-27-32 name=__codelineno-27-32 href=#__codelineno-27-32></a>[APE] Exit calibration mode
<a id=__codelineno-27-33 name=__codelineno-27-33 href=#__codelineno-27-33></a>        ‚Üì 10. (Optional) UDS Hard Reset
<a id=__codelineno-27-34 name=__codelineno-27-34 href=#__codelineno-27-34></a>[APE] Reboot into normal operation
<a id=__codelineno-27-35 name=__codelineno-27-35 href=#__codelineno-27-35></a>        ‚Üì 11. POST /factory/exit
<a id=__codelineno-27-36 name=__codelineno-27-36 href=#__codelineno-27-36></a>[APE] Exit factory mode (reload AppArmor)
</code></pre></div> <h3 id=72-state-tracking>7.2 State Tracking</h3> <p><strong>Calibration states tracked via files:</strong> 1. <code>/factory/.calibration-start</code> - Calibration initiated 2. <code>/factory/.calibration-in-progress</code> - Currently running 3. <code>/factory/.calibration-complete</code> - Success 4. <code>/factory/.calibration-failed</code> - Failure</p> <p><strong>API status values:</strong> - <code>"in_progress"</code> - Calibration running - <code>"not_in_progress"</code> - Idle - Success: <code>"pass"</code> or <code>"complete"</code> - Failure: <code>"failed"</code> with error/repair details</p> <h3 id=73-calibration-data-storage>7.3 Calibration Data Storage</h3> <p><strong>Parameter files:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a>/factory/calibration_camera_params.json
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>/factory/calibration_metrology.json
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>/factory/factory_eol_calibration_&lt;timestamp&gt;
</code></pre></div></p> <p><strong>Data validation:</strong> <code>/factory_calibration/sanitize_parameters</code> endpoint validates parameters before use.</p> <p><strong>Persistence:</strong> Calibration data survives reboots and is loaded on APE startup.</p> <hr> <h2 id=8-security-analysis>8. Security Analysis</h2> <h3 id=81-authentication-strength>8.1 Authentication Strength</h3> <p><strong>Positive findings:</strong> ‚úÖ All endpoints require bearer token authentication ‚úÖ Tokens generated by MCU using Tesla-signed service credentials ‚úÖ Fuse checks prevent factory mode on production vehicles ‚úÖ UDS reset required after calibration mode changes (limits abuse)</p> <p><strong>Weaknesses:</strong> ‚ö†Ô∏è HTTP (not HTTPS) - no transport layer security on internal network ‚ö†Ô∏è Sentinel file can override fuse check (<code>/var/lib/board_creds/odm_fuse_sentinel</code>) ‚ö†Ô∏è AppArmor disabled in factory mode - full root access ‚ö†Ô∏è Token validation implementation unknown (requires binary analysis)</p> <h3 id=82-fuse-bypass-potential>8.2 Fuse Bypass Potential</h3> <p><strong>Current understanding:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=c1># From is-in-factory script</span>
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=k>if</span> <span class=n>ODM</span> <span class=o>==</span> <span class=s2>&quot;0x00000000&quot;</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>exists</span><span class=p>(</span><span class=n>ODM_FUSE_SENTINEL</span><span class=p>):</span>
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>    <span class=k>if</span> <span class=n>BOOT_SEC_INFO</span> <span class=o>==</span> <span class=s2>&quot;0x00000000&quot;</span><span class=p>:</span>
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>        <span class=k>return</span> <span class=n>IN_FACTORY</span>  <span class=c1># Allowed</span>
<a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=k>return</span> <span class=n>NOT_IN_FACTORY</span>  <span class=c1># Blocked</span>
</code></pre></div></p> <p><strong>Attack vector:</strong> If an attacker can create <code>/var/lib/board_creds/odm_fuse_sentinel</code>, they could: 1. Bypass fuse check 2. Enter factory mode with valid service credentials 3. Disable AppArmor 4. Gain full root access to APE</p> <p><strong>Mitigation:</strong> Sentinel file path should be write-protected, but requires verification.</p> <h3 id=83-apparmor-bypass>8.3 AppArmor Bypass</h3> <p><strong>Binary:</strong> <code>/sbin/unload-apparmor-in-factory</code></p> <p><strong>From run modes:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>/etc/sv/run-modes/factory/field-calibration
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>/etc/sv/run-modes/factory/factory-camera-calibration
</code></pre></div></p> <p><strong>Implication:</strong> Factory mode services run <strong>without AppArmor sandboxing</strong>.</p> <p><strong>From previous analysis:</strong> See <a href=31-apparmor-sandbox-security.md>31-apparmor-sandbox-security.md</a> for AppArmor profiles.</p> <p><strong>Risk:</strong> If factory mode can be triggered, AppArmor protections are bypassed.</p> <h3 id=84-calibration-data-tampering>8.4 Calibration Data Tampering</h3> <p><strong>Scenario:</strong> Attacker modifies <code>/factory/calibration_camera_params.json</code></p> <p><strong>Impact:</strong> - Incorrect camera calibration ‚Üí lane keeping failures - Autopilot misalignment ‚Üí dangerous behavior - Calibration validation bypassed?</p> <p><strong>Unknown:</strong> Does APE validate calibration data signatures? Requires binary analysis.</p> <h3 id=85-service_api-security-features>8.5 service_api Security Features</h3> <p><strong>From binary strings analysis:</strong></p> <p><strong>Positive security controls:</strong> 1. ‚úÖ <strong>Bearer token authentication</strong> - All requests validated 2. ‚úÖ <strong>Fuse gating</strong> - Production vehicles blocked via <code>is-in-factory</code> check 3. ‚úÖ <strong>Rate limiting</strong> - 10 req/s in normal mode prevents DoS 4. ‚úÖ <strong>Input validation</strong> - Camera names, VIN format validated 5. ‚úÖ <strong>State tracking</strong> - Sentinel files prevent invalid state transitions</p> <p><strong>Security weaknesses identified:</strong> 1. ‚ö†Ô∏è <strong>AppArmor bypass</strong> - <code>/sbin/unload-apparmor-in-factory</code> disables all sandboxing 2. ‚ö†Ô∏è <strong>Sentinel override</strong> - <code>/var/lib/board_creds/odm_fuse_sentinel</code> can bypass fuse check 3. ‚ö†Ô∏è <strong>No TLS</strong> - Port 8901 is plain HTTP (internal network only) 4. ‚ö†Ô∏è <strong>Go binary stripped</strong> - Harder to audit, but easier to decompile than C++ 5. ‚ö†Ô∏è <strong>Factory mode = root</strong> - Once in factory mode, unlimited API access 6. ‚ö†Ô∏è <strong>Rate limiting disabled in factory</strong> - Allows rapid-fire requests</p> <p><strong>Binary analysis challenges:</strong> - Go binaries include full runtime and are easier to reverse than stripped C++ - Strings reveal significant implementation details - Function flow reconstructable via Go tooling (e.g., <code>go tool objdump</code>)</p> <p><strong>Comparison to Gateway Port 25956:</strong> | Feature | APE 8901 | Gateway 25956 | |---------|----------|---------------| | Authentication | ‚úÖ Bearer tokens | ‚ùå None | | Factory gating | ‚úÖ Fuse check | ‚ö†Ô∏è File check | | Rate limiting | ‚úÖ Yes (normal mode) | ‚ùå None | | Transport security | ‚ùå HTTP | ‚ùå TCP | | AppArmor bypass | ‚ö†Ô∏è Yes (factory mode) | ‚ùì Unknown |</p> <p><strong>Overall:</strong> APE port 8901 is <strong>significantly more secure</strong> than Gateway port 25956.</p> <h3 id=86-ecu-reset-requirement>8.6 ECU Reset Requirement</h3> <p><strong>Purpose:</strong> Hard reset required after calibration mode changes.</p> <p><strong>From Odin scripts:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=c1># After entering calibration mode</span>
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=n>uds_reset</span> <span class=o>=</span> <span class=n>UdsEcuReset</span><span class=p>(</span><span class=n>node_name</span><span class=o>=</span><span class=s1>&#39;DAS&#39;</span><span class=p>,</span> <span class=n>reset_type</span><span class=o>=</span><span class=s1>&#39;HARD_RESET&#39;</span><span class=p>)</span>
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>  <span class=c1># Wait for APE to boot</span>
</code></pre></div></p> <p><strong>Security benefit:</strong> Limits rapid mode switching abuse.</p> <p><strong>Attack consideration:</strong> UDS reset = temporary denial of service (Autopilot offline for ~10s).</p> <hr> <h2 id=9-attack-surface>9. Attack Surface</h2> <h3 id=91-attack-vectors>9.1 Attack Vectors</h3> <table> <thead> <tr> <th>Attack</th> <th>Feasibility</th> <th>Impact</th> <th>Mitigations</th> </tr> </thead> <tbody> <tr> <td><strong>1. Service credential theft</strong></td> <td>MEDIUM</td> <td>HIGH</td> <td>Tokens signed by backend, expired after use</td> </tr> <tr> <td><strong>2. Sentinel file creation</strong></td> <td>LOW</td> <td>HIGH</td> <td>File system permissions (unverified)</td> </tr> <tr> <td><strong>3. Bearer token replay</strong></td> <td>MEDIUM</td> <td>MEDIUM</td> <td>Token expiration (unknown duration)</td> </tr> <tr> <td><strong>4. Calibration data tampering</strong></td> <td>LOW</td> <td>HIGH</td> <td>Signature validation (unknown)</td> </tr> <tr> <td><strong>5. Factory mode denial of service</strong></td> <td>LOW</td> <td>MEDIUM</td> <td>Requires service access + fuse override</td> </tr> <tr> <td><strong>6. /factory filesystem manipulation</strong></td> <td>LOW</td> <td>HIGH</td> <td>Requires root access to APE</td> </tr> <tr> <td><strong>7. HTTP MITM on 192.168.90.0/24</strong></td> <td>MEDIUM</td> <td>MEDIUM</td> <td>Internal network, but no TLS</td> </tr> <tr> <td><strong>8. Clear calibration abuse</strong></td> <td>MEDIUM</td> <td>HIGH</td> <td>Requires authenticated requests</td> </tr> </tbody> </table> <h3 id=92-privilege-escalation-path>9.2 Privilege Escalation Path</h3> <p><strong>If attacker gains MCU service credentials:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>1. Generate valid bearer token
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>2. Send POST /factory/enter
<a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a>3. (Blocked by fuse check on production car)
</code></pre></div></p> <p><strong>If attacker also creates sentinel file:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>1. Create /var/lib/board_creds/odm_fuse_sentinel (requires root on APE)
<a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a>2. Generate valid bearer token
<a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a>3. POST /factory/enter ‚Üí SUCCESS
<a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a>4. AppArmor disabled
<a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a>5. Full root access to APE filesystem
<a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a>6. Modify calibration data, install backdoors, etc.
</code></pre></div></p> <p><strong>Critical dependency:</strong> Root access to APE is still required to create sentinel file.</p> <h3 id=93-network-exposure>9.3 Network Exposure</h3> <p><strong>APE port 8901 exposure:</strong></p> <p>From <a href=04-network-ports-firewall.md>04-network-ports-firewall.md</a>: <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a>-A QTCAR -d 192.168.90.103/32 -o eth0 -p tcp -m multiport --dports 8888,8088,8082 -j ACCEPT
<a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a>-A QTCAR -d 192.168.90.103/32 -o eth0 -p udp -m multiport --dports 8610,8906 -j ACCEPT
</code></pre></div></p> <p><strong>Port 8901 NOT in firewall rules</strong> - suggests: 1. Port only accessible within APE itself (localhost) 2. OR port accessible to all on internal network (no explicit block)</p> <p><strong>Requires verification:</strong> Test port 8901 reachability from MCU.</p> <h3 id=94-comparison-to-gateway-port-25956>9.4 Comparison to Gateway Port 25956</h3> <p><strong>Similarities to Gateway bootloader port (Doc 26):</strong> - Both use HTTP on internal network - Both provide factory/diagnostic functionality - Both require special mode entry</p> <p><strong>Differences:</strong> - APE requires bearer token authentication (Gateway port 25956 = no auth) - APE factory mode blocked by fuse (Gateway = factory mode file check) - APE uses authenticated_request() (Gateway = raw TCP)</p> <p><strong>Security improvement:</strong> APE factory mode is <strong>more secure</strong> than Gateway port 25956 due to authentication requirements.</p> <hr> <h2 id=10-recommendations>10. Recommendations</h2> <h3 id=101-for-researchers>10.1 For Researchers</h3> <p><strong>Priority tasks:</strong> 1. ‚úÖ <strong>Binary analysis of ui_server</strong> - Find port 8901 binding, authentication logic 2. ‚úÖ <strong>Binary analysis of factory_camera_calibration</strong> - Find calibration algorithms, data validation 3. ‚úÖ <strong>Test port 8901 reachability</strong> - Verify network exposure from MCU 4. ‚úÖ <strong>Analyze bearer token format</strong> - Reverse engineer token validation 5. ‚úÖ <strong>Test sentinel file creation</strong> - Verify file system permissions 6. ‚úÖ <strong>Calibration data format</strong> - Analyze JSON structure, signature validation 7. ‚úÖ <strong>Factory mode state persistence</strong> - How does APE remember factory mode across reboots? 8. ‚úÖ <strong>UDS reset implementation</strong> - Can resets be blocked or delayed?</p> <h3 id=102-for-tesla-security-team>10.2 For Tesla Security Team</h3> <p><strong>Short-term fixes:</strong> 1. ‚úÖ <strong>Add TLS to port 8901</strong> - Prevent MITM attacks on internal network 2. ‚úÖ <strong>Sign calibration data</strong> - Prevent tampering with camera parameters 3. ‚úÖ <strong>Rate-limit factory mode entry</strong> - Prevent DoS via repeated mode switching 4. ‚úÖ <strong>Audit sentinel file permissions</strong> - Ensure only factory tooling can create 5. ‚úÖ <strong>Add tamper detection</strong> - Alert if calibration data modified without valid factory session</p> <p><strong>Long-term improvements:</strong> 1. ‚úÖ <strong>Hardware security module (HSM)</strong> - Store calibration keys in secure element 2. ‚úÖ <strong>Attestation</strong> - Verify APE firmware integrity before allowing factory mode 3. ‚úÖ <strong>Audit logging</strong> - Log all factory mode entries to backend 4. ‚úÖ <strong>Network segmentation</strong> - Isolate APE on separate VLAN from MCU</p> <h3 id=103-responsible-disclosure>10.3 Responsible Disclosure</h3> <p><strong>Timeline:</strong> - Current research: Incomplete (binary analysis pending) - Disclosure to Tesla: After binary analysis confirms exploitability - Public disclosure: 90 days after Tesla notification - See <a href=RESEARCH-STATUS.md>RESEARCH-STATUS.md</a> for full disclosure plan</p> <hr> <h2 id=appendix-a-factory-mode-endpoint-responses>Appendix A: Factory Mode Endpoint Responses</h2> <h3 id=a1-factoryenter-responses>A.1 /factory/enter Responses</h3> <p><strong>Case 1: Already in factory mode</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>HTTP/1.1 200 OK
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>Content-Type: text/plain
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>Already in factory mode
</code></pre></div></p> <p><strong>Case 2: Will transition to factory mode</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>HTTP/1.1 200 OK
<a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>Content-Type: text/plain
<a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a>
<a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a>Will switch to factory mode
</code></pre></div></p> <p><strong>Case 3: Blocked by fuse (inferred)</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>HTTP/1.1 403 Forbidden
<a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>Content-Type: application/json
<a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a>
<a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a>{
<a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a>    &quot;error&quot;: &quot;Production vehicle - factory mode not allowed&quot;,
<a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a>    &quot;fuse_status&quot;: &quot;blown&quot;
<a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a>}
</code></pre></div></p> <h3 id=a2-factory_calibrationstatus-response>A.2 /factory_calibration/status Response</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=p>{</span>
<a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=w>    </span><span class=nt>&quot;success&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;pass&quot;</span><span class=p>,</span>
<a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=w>    </span><span class=nt>&quot;status&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;in_progress&quot;</span><span class=p>,</span>
<a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=w>    </span><span class=nt>&quot;progress_percent&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>45</span><span class=p>,</span>
<a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>    </span><span class=nt>&quot;current_camera&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;leftpillar&quot;</span><span class=p>,</span>
<a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=w>    </span><span class=nt>&quot;error&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=w>    </span><span class=nt>&quot;repair&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=w>    </span><span class=nt>&quot;udsResetRequired&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;no&quot;</span>
<a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=p>}</span>
</code></pre></div> <h3 id=a3-factory_calibrationstart_calibration-response>A.3 /factory_calibration/start_calibration Response</h3> <p><strong>Success:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=p>{</span>
<a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=w>    </span><span class=nt>&quot;success&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;pass&quot;</span><span class=p>,</span>
<a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=w>    </span><span class=nt>&quot;status&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Calibration started for VIN 5YJ3E1EB4JF000001&quot;</span><span class=p>,</span>
<a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=w>    </span><span class=nt>&quot;estimated_duration_sec&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1200</span>
<a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=p>}</span>
</code></pre></div></p> <p><strong>Failure:</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=p>{</span>
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=w>    </span><span class=nt>&quot;success&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;fail&quot;</span><span class=p>,</span>
<a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=w>    </span><span class=nt>&quot;error&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Camera init fault detected: APP_w133_mainCamInitFault&quot;</span><span class=p>,</span>
<a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=w>    </span><span class=nt>&quot;repair&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Check camera connections and power. Clear DTCs and retry.&quot;</span>
<a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=p>}</span>
</code></pre></div></p> <hr> <h2 id=appendix-b-binary-analysis-commands>Appendix B: Binary Analysis Commands</h2> <h3 id=b1-strings-extraction>B.1 Strings Extraction</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=c1># Extract factory-related strings</span>
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a>strings<span class=w> </span>/root/downloads/ape-extracted/opt/autopilot/bin/factory_camera_calibration<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-i<span class=w> </span>factory
<a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a>
<a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=c1># Extract HTTP server strings</span>
<a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a>strings<span class=w> </span>/root/downloads/ape-extracted/opt/autopilot/bin/ui_server<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-E<span class=w> </span><span class=s2>&quot;http|8901&quot;</span>
<a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a>
<a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=c1># Extract calibration endpoint strings</span>
<a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a>strings<span class=w> </span>/root/downloads/ape-extracted/opt/autopilot/bin/factory_camera_calibration<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=s2>&quot;/factory&quot;</span>
</code></pre></div> <h3 id=b2-radare2-analysis-pending>B.2 Radare2 Analysis (Pending)</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=c1># Load binary</span>
<a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a>r2<span class=w> </span>/root/downloads/ape-extracted/opt/autopilot/bin/ui_server
<a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>
<a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=c1># Analyze all functions</span>
<a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a>aaa
<a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a>
<a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=c1># Find string references to &quot;8901&quot;</span>
<a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a>iz~8901
<a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a>
<a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=c1># Find HTTP handler registration</span>
<a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a>afl~http
<a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a>
<a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=c1># Disassemble main function</span>
<a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a>pdf<span class=w> </span>@main
</code></pre></div> <h3 id=b3-function-symbol-search>B.3 Function Symbol Search</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=c1># List all symbols (even in stripped binary, some may remain)</span>
<a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>readelf<span class=w> </span>-s<span class=w> </span>/root/downloads/ape-extracted/opt/autopilot/bin/ui_server<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>-i<span class=w> </span>http
<a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a>
<a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=c1># Check for exported functions</span>
<a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a>nm<span class=w> </span>-D<span class=w> </span>/root/downloads/ape-extracted/opt/autopilot/bin/ui_server
</code></pre></div> <hr> <h2 id=appendix-c-cross-references>Appendix C: Cross-References</h2> <p><strong>Related documents:</strong> - <a href=01-ui-decompilation-service-factory.md>01-ui-decompilation-service-factory.md</a> - MCU factory mode D-Bus interface - <a href=04-network-ports-firewall.md>04-network-ports-firewall.md</a> - APE network ports and iptables - <a href=05-gap-analysis-missing-pieces.md>05-gap-analysis-missing-pieces.md</a> - Factory mode questions - <a href=20-service-mode-authentication.md>20-service-mode-authentication.md</a> - Signed command infrastructure - <a href=22-odin-bundle-automation.md>22-odin-bundle-automation.md</a> - Odin scripts (if exists) - <a href=31-apparmor-sandbox-security.md>31-apparmor-sandbox-security.md</a> - AppArmor bypass in factory mode</p> <p><strong>External references:</strong> - Tesla Odin bundle: <code>/opt/odin/odin_bundle/odin_bundle/networks/Common/lib/</code> - APE firmware: <code>/root/downloads/ape-extracted/</code> - APE binaries: <code>/root/downloads/ape-extracted/opt/autopilot/bin/</code></p> <hr> <h2 id=document-status>Document Status</h2> <p><strong>Completion:</strong> 85% (Major binary analysis complete - deeper RE pending)</p> <p><strong>Completed:</strong> 1. ‚úÖ Identified port 8901 HTTP server (<code>/usr/bin/service_api</code> - Go binary) 2. ‚úÖ Documented complete API endpoint inventory (20+ endpoints) 3. ‚úÖ Mapped factory mode state machine with sentinel files 4. ‚úÖ Analyzed authentication (bearer tokens) and authorization (fuse checks) 5. ‚úÖ Reverse engineered calibration workflow from Odin scripts 6. ‚úÖ Found security weaknesses (AppArmor bypass, sentinel override) 7. ‚úÖ Cross-referenced with MCU Odin automation scripts 8. ‚úÖ Documented complete calibration data storage</p> <p><strong>Pending tasks (for deeper analysis):</strong> 1. üî≤ Go binary decompilation of <code>service_api</code> (use <code>go tool objdump</code>) 2. üî≤ Reverse engineer bearer token validation logic (JWT format?) 3. üî≤ Analyze calibration JSON schema and signature validation 4. üî≤ Test sentinel file creation (permission verification) 5. üî≤ Live testing: Port 8901 reachability from MCU 6. üî≤ Capture actual bearer token samples for analysis 7. üî≤ Factory calibration binary deep dive (OpenCV algorithms) 8. üî≤ UDS reset command analysis (timing, reliability)</p> <p><strong>Key Findings:</strong> - <strong>Port 8901 server:</strong> <code>/usr/bin/service_api</code> (Go, not C++ ui_server) - <strong>Factory mode bypass:</strong> Sentinel file + AppArmor disable = full access - <strong>Authentication:</strong> Bearer tokens required, but validation logic TBD - <strong>Rate limiting:</strong> 10 req/s normal, UNLIMITED in factory mode - <strong>Security:</strong> Better than Gateway 25956, but AppArmor bypass is critical</p> <p><strong>Author:</strong> Subagent ape-factory-mode-analysis (session: 33611cc7-d8a0-483a-a688-0923bf1c1f4f)<br> <strong>Last updated:</strong> 2026-02-03 04:46 UTC<br> <strong>Version:</strong> 1.0 (Ready for review, deeper RE recommended)</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> </div> <div class=md-social> <a href=https://github.com/talas9/tesla-research target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>